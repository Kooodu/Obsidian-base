
## 001 Загрузка файлов

Очень хорошей практикой будет реализовать сервер, который примет изображения и будет сам на фронт отправлять их в формат webp

Тут мы так же сохраняем архитектуру классического сервера:
- контроллер хранит логику принятия и отправки результатов запросов посредством использования методов из сервиса
- сервис же выполняет конкретную логику для выполнения задачи

```bash
nest g module files
nest g controller files --no-spec
nest g service files --no-spec
```

Данный модуль позволит нам типизировать файлы

```bash
npm i -D @types/multer
```

Данный модуль позволит нам упростить работу с встроенным в ноду функционалом `fs` (например, не писать проверки на существование папки)

```bash
npm i fs-extra
npm i -D @types/fs-extra
```

Данный модуль позволит нам вне зависимости от ОС определять корневую папку корректно

```bash
npm i app-root-path
npm i -D @types/app-root-path
```

Далее нам нужно будет реализовать функционал для генерации папки с именем дня, чтобы складывать в неё изображения 

```bash
npm i date-fns
```

Первым делом нужно описать тот ответ, который мы должны отправить на клиент. Он будет содержать ссылку до изображения и его имя

`src > files > dto > file-element.response.ts`
```TS
export class FileElementResponse {
	url: string;
	name: string;
}
```

Interceptor - это декторатор в несте, который позволяет перехватить запрос и (например) воспользоваться напрямую функцией для работы с файлами

Конкретно можно обернуть контроллер в `@UseInterceptors()`, в который вложим `FileInterceptor('files')` (`'files'` - это имя мультиплатформы, в которой лежит файл), который уже и предоставит нам возможность работать с методами файлов

`src > files > files.controller.ts`
```TS
import { Controller, Post, UploadedFile, UseGuards, UseInterceptors } from '@nestjs/common';
import { HttpCode } from '@nestjs/common/decorators';
import { JwtAuthGuard } from '../auth/guards/jwt.guard';
import { FileInterceptor } from '@nestjs/platform-express';
import { FileElementResponse } from './dto/file-element.response';
import { FilesService } from './files.service';

@Controller('files')
export class FilesController {
	constructor(private readonly filesService: FilesService) {}

	// загружаем файлы на сервер и сохраняем их
	@Post('upload')
	@HttpCode(200)
	@UseGuards(JwtAuthGuard)
	@UseInterceptors(FileInterceptor('file'))
	async uploadFiles(@UploadedFile() file: Express.Multer.File): Promise<FileElementResponse[]> {
		return this.filesService.saveFiles([file]);
	}
}
```

Далее нам нужно реализовать сервис:
- `ensureDir` - данная функция обеспечивает создания дирректории (если папка есть, то хорошо, а если нет, то она будет создана)

`src > files > files.service.ts`
```TS
import { Injectable } from '@nestjs/common';
import { FileElementResponse } from './dto/file-element.response';
import { format } from 'date-fns';
import { path } from 'app-root-path';
import { ensureDir, writeFile } from 'fs-extra';

@Injectable()
export class FilesService {
	async saveFiles(files: Express.Multer.File[]): Promise<FileElementResponse[]> {
		// генерируем текущую дату
		const dateFolder = format(new Date(), 'yyyy-MM-dd');

		// папка, куда будем загружать изображения
		const uploadFolder = `${path}/uploads/${dateFolder}`;

		// обеспечиваем создание папки
		await ensureDir(uploadFolder);

		// это тот ответ с ссылками, который нужно вернуть из метода
		const res: FileElementResponse[] = [];

		// проходимся по массиву полученных файлов
		for (const file of files) {
			// записываем файлы в нужную нам папку
			await writeFile(`${uploadFolder}/${file.originalname}`, file.buffer);
			// пушим ссылки до файлов в массив ответа из метода
			res.push({
				url: `/uploads/${dateFolder}/${file.originalname}`,
				name: file.originalname,
			});
		}

		return res;
	}
}
```

Далее совершаем запрос с представленными параетрами:

![](_png/Pasted%20image%2020230406163330.png)

![](_png/Pasted%20image%2020230406163326.png)

![](_png/Pasted%20image%2020230406163323.png)

И получаем в ответ массив ссылок на изображения

![](_png/Pasted%20image%2020230406163320.png)

## 002 Конвертация изображений








## 003 Serve файлов








