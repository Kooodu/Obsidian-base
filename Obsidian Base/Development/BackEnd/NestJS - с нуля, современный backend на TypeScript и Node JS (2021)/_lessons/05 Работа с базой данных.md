#MongoDB 

## 001 Работа с переменными окружения

Установим средство NestJS для работы с конфигом

```bash
npm i @nestjs/config
```

Далее добавим зависимость `ConfigModule.forRoot()` в корневой модуль, которая позволит нам во всём проекте использовать один и тот же файл конфигурации (глобализирует модуль `forRoot`). Она позволит нам работать с переменными окружения.

`src / app.module.ts`
```TS
@Module({
	imports: [ConfigModule.forRoot(), AuthModule, TopPageModule, ProductModule, ReviewModule],
	controllers: [AppController],
	providers: [AppService],
})
export class AppModule {}
```

Записываем какое-либо значение в переменные окружения.

`.env`
```env
TEST=1
```

И уже в любом другом нужном нам модуле мы можем заинжектить этот сервис по работе с переменными окружения и воспользоваться его функционалом: получить значение переменной можно с помощью функции `get()`, которая принимает в себя наименование переменной.

`src / top-page / top-page.controller.ts`
```TS
@Controller('top-page')
export class TopPageController {
	constructor(private readonly configService: ConfigService) {}

	@Get(':id')
	async get(@Param('id') id: string) {
		return this.configService.get('TEST');
	}

	/// CODE ...
}
```

![](_png/Pasted%20image%2020230402132725.png)

## 002 Подготовка окружения

Первым делом нужно установить на ПК [Docker](https://www.docker.com/products/docker-desktop/)

После установки докера, нужно настроить его окружение под наш проект:
- `version` - минимальная версия докера
- `services` - сервисы, которые используются в данном контейнере
- `image` - образ, который запускает контейнер
- `container_name` - имя контейнера
- `restart` - перезапуск каждый раз, когда у нас перезагрузился сервер
- `environment` - переменные окружения (логин и пароль администратора)
- `ports` - позволяет прокинуть порт изнутри контейнера наружу (без них не получится подключиться к БД)
- `volumes` - позволяет подключить часть дискового пространства внутри контейнера к диску на сервере (компьютере)
- `command` -  команды (ограничение кеша для БД)

`docker-compose.yml`
```yml
version: '3'  
services:  
  mongo:  
    image: mongo:4.4.4  
    container_name: mongo  
    restart: always  
    environment:  
      - MONGO_INITDB_ROOT_USERNAME=admin  
      - MONGO_INITDB_ROOT_PASSWORD=admin  
    ports:  
      - 27017:27017  
    volumes:  
      - ./mongo-data-4.4:/data/db  
    command: --wiredTigerCacheSizeGB 1.5
```

Позволяет поднять контейнер по заданным параметрам (по файлу `docker-compose.yml` в папке, где запускается команда):

```bash
docker-compose up -d
```

![](_png/Pasted%20image%2020230203185144.png)

Позволяет посмотреть контейнеры | выбираем отдельный контейнер монги:

```bash
docker ps | grep mongo
```

*Примечание: `grep` работает только на unix-системах*

![](_png/Pasted%20image%2020230203185507.png)

Так же посмотреть на статус контейнера можно через десктопное приложение докера

![](_png/Pasted%20image%2020230402134654.png)

Остановить и запустить контейнер мы можем следующими комадами:

```bash
docker stop <имя_контейнера>
docker start <имя_контейнера>
```

![](_png/Pasted%20image%2020230203185629.png)

## 003 Подключение Mongo

Сейчас нам нужно установить данные модули:
- `mongoose` - удобная ORM для монги
- `typegoose` - позволяет проще описать модели для `mongoose`
-  `nestjs-typegoose` - позволяет использовать `typegoose` в несте более нативно (приближенно к основным подходам фреймворка)

```bash
// тут может потребоваться --legacy-peer-deps
npm i @typegoose/typegoose mongoose nestjs-typegoose 

npm i -D @types/mongoose 
```

Записываем переменные для подключения к монге в окружение

`.env`
```env
MONGO_LOGIN=admin  
MONGO_PASSWORD=admin  
MONGO_HOST=localhost  
MONGO_PORT=27017  
MONGO_AUTHDATABASE=admin
```

Далее, в основном модуле приложения, подключим модуль провайдера монги `TypegooseModule`

Тут мы используем вместо `forRoot` метод `forRootAsync`, который позволит асинхронно инициализировать модуль вместе с его зависимостями. Это делается для того, чтобы иметь возможность использовать `ConfigModule` в зависимостях модуля тайпгуза

Для того, чтобы использовать любой провайдер, нужно использовать модуль, который содержит этот провайдер, поэтому вставляем в `import` модуль `ConfigModule`

В `inject` мы вставляем зависимость из `ConfigModule`, а именно тут это `ConfigService`, который позволит нам получить данные из `.env`

Внутрь useFactory будет помещать функцию, которая сгенерирует строку подключения к БД монги `getMongoConfig`.

`src / app.module.ts`
```TS
@Module({  
   imports: [  
      ConfigModule.forRoot(),  
      // асинхронно подключаем конфигурацию  
      TypegooseModule.forRootAsync({  
         // тут мы импортируем модули провайдеров  
         imports: [ConfigModule],  
         // тут мы вставляем зависимость в фэктори из модуля, который в него импортировали  
         inject: [ConfigService],  
         // сюда мы передаём конфиг подключения к монге  
         useFactory: getMongoConfig,  
      }),  
      AuthModule,  
      TopPageModule,  
      ProductModule,  
      ReviewModule,  
   ],  
   controllers: [AppController],  
   providers: [AppService],  
})  
export class AppModule {}
```

Сейчас нам нужно написать саму функцию `getMongoConfig`, которая сгенерирует параметры подключения. 

Таким образом должен выглядеть объект подключения по типам:

![](_png/Pasted%20image%2020230402142217.png)

Все конфиги, которые мы передаём в модули, лучше складировать в папку `configs`.

- `getMongoConfig` - эта функция возвращает объект, который содержит в себе строку подключения к монге и деструктурированный объект, возвращаемый из функции, которая возвращает опции монги
- `getMongoString` - возвращает строку подключения к монге через обращение к `configService`
- `getMongoOptions` - возвращает опции для подключения к монге

`src / configs / mongo.config.ts`
```TS
import { ConfigService } from '@nestjs/config';  
import { TypegooseModuleOptions } from 'nestjs-typegoose';  
  
// получаем строку подключения к монге  
const getMongoString = (configService: ConfigService) =>  
   'mongodb://' +  
   configService.get('MONGO_LOGIN') +  
   ':' +  
   configService.get('MONGO_PASSWORD') +  
   '@' +  
   configService.get('MONGO_HOST') + // хост
   ':' +  
   configService.get('MONGO_PORT') + // порт
   '/' +  
   configService.get('MONGO_AUTHDATABASE'); // база, к которой подключаемся
  
// получение опций для подключения к монге  
const getMongoOptions = () => ({ });  
  
// это функция получения конфига для подключения к монге  
export const getMongoConfig = async (  
   configService: ConfigService,  
): Promise<TypegooseModuleOptions> => {  
   // возвращаем объект, который вызывает две функции, которые вернут нам - строку и опции для подключения  
   return {  
      uri: getMongoString(configService),  
      ...getMongoOptions(),  
   };  
};
```

И теперь `npm start` запустит наш сервер с подключением к монге

![](_png/Pasted%20image%2020230402145746.png)

## 004 Подключение моделей







## 005 Сервис отзывов







## 006 Упражнение 2 - Удаление отзывов по продукту








